<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=GT-K5QNXGSM"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "GT-K5QNXGSM");
    </script>
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-NM5V9XQ2");
    </script>
    <!-- End Google Tag Manager -->
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-NM5V9XQ2"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe
    ></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="crystal-ball-container" [class.active]="isVisible">
      <div class="crystal-backdrop" (click)="onWheelClosedHandler()"></div>

      <div class="crystal-modal">
        <div class="crystal-header">
          <h2>Consulta el Oráculo Cósmico</h2>
          <button class="close-crystal-btn" (click)="onWheelClosedHandler()">
            ✕
          </button>
        </div>

        <div class="crystal-content">
          <!-- Base ornamental -->
          <div class="crystal-base">
            <div class="base-details">
              <div class="base-ring"></div>
              <div class="base-runes">
                <span class="rune">∴</span>
                <span class="rune">⋄</span>
                <span class="rune">∴</span>
              </div>
            </div>
          </div>

          <!-- Bola de cristal -->
          <div class="crystal-ball-wrapper">
            <div
              class="crystal-ball"
              #crystalElement
              [class.spinning]="wheelSpinning"
              [class.revealing]="selectedPrize && !wheelSpinning"
            >
              <!-- Partículas místicas flotantes -->
              <div class="mystic-particles">
                <div
                  class="particle"
                  style="--delay: 0s; --x: 20%; --y: 30%"
                ></div>
                <div
                  class="particle"
                  style="--delay: 1s; --x: 80%; --y: 20%"
                ></div>
                <div
                  class="particle"
                  style="--delay: 2s; --x: 30%; --y: 70%"
                ></div>
                <div
                  class="particle"
                  style="--delay: 3s; --x: 70%; --y: 80%"
                ></div>
                <div
                  class="particle"
                  style="--delay: 4s; --x: 50%; --y: 40%"
                ></div>
                <div
                  class="particle"
                  style="--delay: 5s; --x: 60%; --y: 60%"
                ></div>
                <div
                  class="particle"
                  style="--delay: 6s; --x: 40%; --y: 20%"
                ></div>
                <div
                  class="particle"
                  style="--delay: 7s; --x: 90%; --y: 50%"
                ></div>
                <div
                  class="particle"
                  style="--delay: 8s; --x: 10%; --y: 80%"
                ></div>
                <div
                  class="particle"
                  style="--delay: 9s; --x: 75%; --y: 35%"
                ></div>
              </div>

              <!-- Energía mística circular -->
              <div class="mystic-energy">
                <div class="energy-ring outer-ring"></div>
                <div class="energy-ring middle-ring"></div>
                <div class="energy-ring inner-ring"></div>
              </div>

              <!-- Galaxia interior girando -->
              <div
                class="galaxy-core"
                [style.transform]="
                  'translate(-50%, -50%) rotate(' + currentRotation + 'deg)'
                "
              >
                <div class="cosmic-dust"></div>
                <div class="stellar-field"></div>
                <div class="nebula-swirl"></div>
                <div class="center-orb"></div>
              </div>

              <!-- ✅ ACTUALIZADO: Elementos flotantes de los premios -->
              <div
                class="prize-elements"
                *ngIf="!wheelSpinning && !selectedPrize"
              >
                <div
                  *ngFor="let prize of prizes; let i = index"
                  class="floating-symbol"
                  [style.animation-delay]="i * 1 + 's'"
                >
                  <div class="symbol-glow">{{ prize.icon }}</div>
                </div>
              </div>

              <!-- ✅ ACTUALIZADO: Resultado en el centro -->
              <div
                class="crystal-result"
                *ngIf="selectedPrize && !wheelSpinning"
              >
                <div class="result-aura">
                  <div class="result-symbol">{{ selectedPrize.icon }}</div>
                  <div class="result-title">{{ selectedPrize.name }}</div>
                </div>
              </div>

              <!-- Reflexos y brillos del cristal -->
              <div class="crystal-reflections">
                <div class="reflection primary-reflection"></div>
                <div class="reflection secondary-reflection"></div>
                <div class="reflection tertiary-reflection"></div>
              </div>

              <!-- Aura exterior -->
              <div class="crystal-aura"></div>
            </div>

            <!-- ✅ ACTUALIZADO: Botón de activación con control completo -->
            <div
              class="oracle-activation"
              [class.disabled]="
                !canSpinWheel || wheelSpinning || isProcessingClick
              "
              [class.processing]="isProcessingClick"
              (click)="spinWheel()"
            >
              <div class="activation-symbol">
                <!-- Estado normal: puede girar -->
                <div
                  *ngIf="!wheelSpinning && !isProcessingClick && canSpinWheel"
                  class="rune-circle"
                >
                  <span class="central-rune">◊</span>
                </div>

                <!-- Estado procesando clic -->
                <div
                  *ngIf="isProcessingClick && !wheelSpinning"
                  class="processing-click"
                >
                  <div class="click-loader"></div>
                </div>

                <!-- Estado girando -->
                <div *ngIf="wheelSpinning" class="channeling-energy">
                  <div class="energy-spiral"></div>
                </div>

                <!-- Estado bloqueado -->
                <div
                  *ngIf="!canSpinWheel && !wheelSpinning && !isProcessingClick"
                  class="disabled-rune"
                >
                  <span class="locked-rune">🔒</span>
                </div>
              </div>

              <div class="activation-label">
                <!-- Texto cuando puede girar -->
                <span
                  *ngIf="!wheelSpinning && !isProcessingClick && canSpinWheel"
                >
                  Consultar Oráculo
                </span>

                <!-- Texto procesando -->
                <span *ngIf="isProcessingClick && !wheelSpinning">
                  Procesando...
                </span>

                <!-- Texto cuando está girando -->
                <span *ngIf="wheelSpinning">Canalizando Energías...</span>

                <!-- Texto cuando ya usó la tirada diaria -->
                <span
                  *ngIf="
                    !canSpinWheel &&
                    !wheelSpinning &&
                    !isProcessingClick &&
                    hasUsedDailyFreeSpIn &&
                    !hasFreeSpinsAvailable()
                  "
                >
                  Ya consultaste hoy
                </span>

                <!-- Texto con tiempo restante -->
                <span
                  *ngIf="
                    !canSpinWheel &&
                    !wheelSpinning &&
                    !isProcessingClick &&
                    !hasUsedDailyFreeSpIn
                  "
                >
                  Próxima consulta en: {{ getTimeUntilNextSpin() }}
                </span>

                <!-- Texto cuando no hay tiradas disponibles -->
                <span
                  *ngIf="
                    !canSpinWheel &&
                    !wheelSpinning &&
                    !isProcessingClick &&
                    hasUsedDailyFreeSpIn &&
                    !hasFreeSpinsAvailable()
                  "
                >
                  Sin tiradas disponibles
                </span>
              </div>

              <!-- ✅ ACTUALIZADO: Indicador de spins extras disponibles -->
              <div
                class="extra-spins-indicator"
                *ngIf="hasFreeSpinsAvailable()"
              >
                <span class="spins-count">
                  🎰 {{ getWheelSpinsCount() }} tiradas de ruleta
                </span>
              </div>

              <!-- ✅ NUEVO: Indicador de consultas disponibles -->
              <div
                class="dream-consultations-indicator"
                *ngIf="getDreamConsultationsCount() > 0"
              >
                <span class="consultations-count">
                  🔮 {{ getDreamConsultationsCount() }} consultas de sueños
                </span>
              </div>
            </div>
          </div>

          <!-- ✅ ACTUALIZADO: Información de estado de la ruleta -->
          <div class="wheel-status">
            <div class="status-info">
              <!-- Info cuando no está girando ni procesando -->
              <div
                class="spin-info"
                *ngIf="!wheelSpinning && !isProcessingClick"
              >
                <span
                  *ngIf="
                    canSpinWheel &&
                    !hasUsedDailyFreeSpIn &&
                    getWheelSpinsCount() === 0
                  "
                >
                  🎁 Tirada diaria gratuita disponible
                </span>
                <span *ngIf="canSpinWheel && getWheelSpinsCount() > 0">
                  🎰 {{ getWheelSpinsCount() }} tiradas de ruleta disponibles
                </span>
                <span *ngIf="!canSpinWheel && !hasFreeSpinsAvailable()">
                  ⏰ Sin tiradas disponibles hasta mañana
                </span>
              </div>

              <!-- Info cuando está procesando -->
              <div
                class="processing-info"
                *ngIf="isProcessingClick && !wheelSpinning"
              >
                <div class="processing-animation">
                  <span class="process-icon">⚡</span>
                  <span class="process-text">Preparando consulta...</span>
                </div>
              </div>

              <!-- Info cuando está girando -->
              <div class="spinning-info" *ngIf="wheelSpinning">
                <div class="spin-animation">
                  <span class="swirl-icon">🌪️</span>
                  <span class="spin-text"
                    >Las energías cósmicas están decidiendo...</span
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- ✅ ACTUALIZADO: Mensaje místico durante spinning -->
          <div class="cosmic-message" *ngIf="wheelSpinning">
            <div class="message-text">
              <h3>Las fuerzas cósmicas revelan tu destino</h3>
              <div class="cosmic-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
              </div>
            </div>
          </div>

          <!-- ✅ ACTUALIZADO: Resultado final -->
          <div
            class="oracle-revelation"
            *ngIf="selectedPrize && !wheelSpinning"
          >
            <div class="revelation-scroll">
              <h3>El Oráculo Ha Hablado</h3>
              <div class="destiny-manifest">
                <div class="manifest-symbol">{{ selectedPrize.icon }}</div>
                <div class="manifest-text">{{ selectedPrize.name }}</div>
              </div>

              <!-- ✅ ACTUALIZADO: Información específica del premio -->
              <div class="prize-description" *ngIf="selectedPrize">
                <p *ngIf="selectedPrize.id === '1'">
                  🎰 Has ganado 3 tiradas adicionales para la ruleta del oráculo
                  <br /><strong
                    >Tiradas disponibles: {{ getWheelSpinsCount() }}</strong
                  >
                </p>
                <p *ngIf="selectedPrize.id === '2'">
                  🔮 Una consulta gratuita de interpretación de sueños te espera
                  <br /><strong
                    >Consultas disponibles:
                    {{ getDreamConsultationsCount() }}</strong
                  >
                </p>
                <p *ngIf="selectedPrize.id === '3'">
                  🎯 2 tiradas extra de ruleta han sido agregadas a tu cuenta
                  <br /><strong
                    >Tiradas disponibles: {{ getWheelSpinsCount() }}</strong
                  >
                </p>
                <p *ngIf="selectedPrize.id === '4'">
                  🔄 Las energías te conceden una tirada inmediata adicional
                  <br /><strong
                    >Tiradas disponibles: {{ getWheelSpinsCount() }}</strong
                  >
                </p>
              </div>

              <!-- ✅ NUEVO: Botones inteligentes según el tipo de premio -->
              <div class="prize-actions">
                <!-- ✅ BOTÓN CONTINUAR para premios que otorgan tiradas -->
                <button
                  class="continue-spinning-btn"
                  (click)="continueSpinning()"
                  *ngIf="
                    shouldShowContinueButton(selectedPrize) &&
                    getWheelSpinsCount() > 0
                  "
                >
                  <span class="continue-icon">🎲</span>
                  ¡Continuar Girando! ({{ getWheelSpinsCount() }} tiradas)
                </button>

                <!-- ✅ MENSAJE cuando ganaste tiradas pero ya no tienes más -->
                <div
                  class="no-more-spins-message"
                  *ngIf="
                    shouldShowContinueButton(selectedPrize) &&
                    getWheelSpinsCount() === 0
                  "
                >
                  <p>🎯 Premio reclamado correctamente</p>
                  <button
                    class="accept-destiny-btn"
                    (click)="onWheelClosedHandler()"
                  >
                    Cerrar
                  </button>
                </div>

                <!-- ✅ BOTÓN CERRAR solo para consulta gratis -->
                <button
                  class="accept-destiny-btn"
                  (click)="onWheelClosedHandler()"
                  *ngIf="shouldShowCloseButton(selectedPrize)"
                >
                  Aceptar Destino
                </button>
              </div>

              <!-- ✅ NUEVO: Estado actual de recursos -->
              <div class="current-resources" *ngIf="selectedPrize">
                <h4>📊 Recursos Actuales:</h4>
                <div class="resource-summary">
                  <div class="resource-item">
                    <span class="resource-icon">🎰</span>
                    <span class="resource-count">{{
                      getWheelSpinsCount()
                    }}</span>
                    <span class="resource-label">Tiradas de Ruleta</span>
                  </div>
                  <div class="resource-item">
                    <span class="resource-icon">🔮</span>
                    <span class="resource-count">{{
                      getDreamConsultationsCount()
                    }}</span>
                    <span class="resource-label">Consultas disponibles</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ✅ NUEVO: Panel de recursos disponibles -->
          <div class="resources-panel" *ngIf="!wheelSpinning && !selectedPrize">
            <div class="resource-item" *ngIf="getWheelSpinsCount() > 0">
              <span class="resource-icon">🎰</span>
              <span class="resource-text"
                >{{ getWheelSpinsCount() }} Tiradas de Ruleta</span
              >
            </div>
            <div class="resource-item" *ngIf="getDreamConsultationsCount() > 0">
              <span class="resource-icon">🔮</span>
              <span class="resource-text"
                >{{ getDreamConsultationsCount() }} Consultas disponibles</span
              >
            </div>
            <div
              class="resource-item"
              *ngIf="
                getWheelSpinsCount() === 0 &&
                getDreamConsultationsCount() === 0 &&
                canSpinWheel
              "
            >
              <span class="resource-icon">🎁</span>
              <span class="resource-text">Tirada Diaria Disponible</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
