<div class="crystal-ball-container" [class.active]="isVisible">
  <div class="crystal-backdrop" (click)="onWheelClosedHandler()"></div>

  <div class="crystal-modal">
    <div class="crystal-header">
      <h2>Consulta el Oráculo Cósmico</h2>
      <button class="close-crystal-btn" (click)="onWheelClosedHandler()">
        ✕
      </button>
    </div>

    <div class="crystal-content">
      <!-- Base ornamental -->
      <div class="crystal-base">
        <div class="base-details">
          <div class="base-ring"></div>
          <div class="base-runes">
            <span class="rune">∴</span>
            <span class="rune">⋄</span>
            <span class="rune">∴</span>
          </div>
        </div>
      </div>

      <!-- Bola de cristal -->
      <div class="crystal-ball-wrapper">
        <div
          class="crystal-ball"
          #crystalElement
          [class.spinning]="wheelSpinning"
          [class.revealing]="selectedPrize && !wheelSpinning"
        >
          <!-- Partículas místicas flotantes -->
          <div class="mystic-particles">
            <div class="particle" style="--delay: 0s; --x: 20%; --y: 30%"></div>
            <div class="particle" style="--delay: 1s; --x: 80%; --y: 20%"></div>
            <div class="particle" style="--delay: 2s; --x: 30%; --y: 70%"></div>
            <div class="particle" style="--delay: 3s; --x: 70%; --y: 80%"></div>
            <div class="particle" style="--delay: 4s; --x: 50%; --y: 40%"></div>
            <div class="particle" style="--delay: 5s; --x: 60%; --y: 60%"></div>
            <div class="particle" style="--delay: 6s; --x: 40%; --y: 20%"></div>
            <div class="particle" style="--delay: 7s; --x: 90%; --y: 50%"></div>
            <div class="particle" style="--delay: 8s; --x: 10%; --y: 80%"></div>
            <div class="particle" style="--delay: 9s; --x: 75%; --y: 35%"></div>
          </div>

          <!-- Energía mística circular -->
          <div class="mystic-energy">
            <div class="energy-ring outer-ring"></div>
            <div class="energy-ring middle-ring"></div>
            <div class="energy-ring inner-ring"></div>
          </div>

          <!-- Galaxia interior girando -->
          <div
            class="galaxy-core"
            [style.transform]="
              'translate(-50%, -50%) rotate(' + currentRotation + 'deg)'
            "
          >
            <div class="cosmic-dust"></div>
            <div class="stellar-field"></div>
            <div class="nebula-swirl"></div>
            <div class="center-orb"></div>
          </div>

          <!-- ✅ ACTUALIZADO: Elementos flotantes de los premios -->
          <div class="prize-elements" *ngIf="!wheelSpinning && !selectedPrize">
            <div
              *ngFor="let prize of prizes; let i = index"
              class="floating-symbol"
              [style.animation-delay]="i * 1 + 's'"
            >
              <div class="symbol-glow">{{ prize.icon }}</div>
            </div>
          </div>

          <!-- ✅ ACTUALIZADO: Resultado en el centro -->
          <div class="crystal-result" *ngIf="selectedPrize && !wheelSpinning">
            <div class="result-aura">
              <div class="result-symbol">{{ selectedPrize.icon }}</div>
              <div class="result-title">{{ selectedPrize.name }}</div>
            </div>
          </div>

          <!-- Reflexos y brillos del cristal -->
          <div class="crystal-reflections">
            <div class="reflection primary-reflection"></div>
            <div class="reflection secondary-reflection"></div>
            <div class="reflection tertiary-reflection"></div>
          </div>

          <!-- Aura exterior -->
          <div class="crystal-aura"></div>
        </div>

        <!-- ✅ NUEVO: Botón de activación con control completo -->
        <div
          class="oracle-activation"
          [class.disabled]="!canSpinWheel || wheelSpinning"
          (click)="spinWheel()"
        >
          <div class="activation-symbol">
            <!-- Estado normal: puede girar -->
            <div *ngIf="!wheelSpinning && canSpinWheel" class="rune-circle">
              <span class="central-rune">◊</span>
            </div>

            <!-- Estado girando -->
            <div *ngIf="wheelSpinning" class="channeling-energy">
              <div class="energy-spiral"></div>
            </div>

            <!-- Estado bloqueado -->
            <div *ngIf="!canSpinWheel && !wheelSpinning" class="disabled-rune">
              <span class="locked-rune">🔒</span>
            </div>
          </div>

          <div class="activation-label">
            <!-- Texto cuando puede girar -->
            <span *ngIf="!wheelSpinning && canSpinWheel"
              >Consultar Oráculo</span
            >

            <!-- Texto cuando está girando -->
            <span *ngIf="wheelSpinning">Canalizando Energías...</span>

            <!-- Texto cuando ya usó la tirada diaria -->
            <span
              *ngIf="
                !canSpinWheel &&
                !wheelSpinning &&
                hasUsedFreeSpinToday &&
                !hasFreeSpinsAvailable()
              "
            >
              Ya consultaste hoy
            </span>

            <!-- Texto con tiempo restante -->
            <span
              *ngIf="!canSpinWheel && !wheelSpinning && !hasUsedFreeSpinToday"
            >
              Próxima consulta en: {{ getTimeUntilNextSpin() }}
            </span>
          </div>

          <!-- ✅ NUEVO: Indicador de spins extras disponibles -->
          <div class="extra-spins-indicator" *ngIf="hasFreeSpinsAvailable()">
            <span class="spins-count"
              >🎲 {{ getFreeSpinsCount() }} tiradas extra</span
            >
          </div>
        </div>
      </div>

      <!-- ✅ NUEVO: Información de estado de la ruleta -->
      <div class="wheel-status">
        <div class="status-info">
          <!-- Info cuando no está girando -->
          <div class="spin-info" *ngIf="!wheelSpinning">
            <span *ngIf="canSpinWheel && !hasUsedFreeSpinToday">
              🎁 Tirada diaria gratuita disponible
            </span>
            <span
              *ngIf="
                canSpinWheel && hasUsedFreeSpinToday && hasFreeSpinsAvailable()
              "
            >
              🎲 Usando tirada extra ({{ getFreeSpinsCount() }} restantes)
            </span>
            <span *ngIf="!canSpinWheel && hasFreeSpinsAvailable()">
              🎲 Tienes {{ getFreeSpinsCount() }} tiradas extra disponibles
            </span>
            <span *ngIf="!canSpinWheel && !hasFreeSpinsAvailable()">
              ⏰ Próxima tirada gratuita: {{ getTimeUntilNextSpin() }}
            </span>
          </div>

          <!-- Info cuando está girando -->
          <div class="spinning-info" *ngIf="wheelSpinning">
            <div class="spin-animation">
              <span class="swirl-icon">🌪️</span>
              <span class="spin-text"
                >Las energías cósmicas están decidiendo...</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ ACTUALIZADO: Mensaje místico durante spinning -->
      <div class="cosmic-message" *ngIf="wheelSpinning">
        <div class="message-text">
          <h3>Las fuerzas cósmicas revelan tu destino</h3>
          <div class="cosmic-dots">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
        </div>
      </div>

      <!-- ✅ ACTUALIZADO: Resultado final -->
      <div class="oracle-revelation" *ngIf="selectedPrize && !wheelSpinning">
        <div class="revelation-scroll">
          <h3>El Oráculo Ha Hablado</h3>
          <div class="destiny-manifest">
            <div class="manifest-symbol">{{ selectedPrize.icon }}</div>
            <div class="manifest-text">{{ selectedPrize.name }}</div>
          </div>

          <!-- ✅ NUEVO: Información adicional del premio -->
          <div class="prize-description" *ngIf="selectedPrize">
            <p *ngIf="selectedPrize.id === '1'">
              ✨ Has ganado 3 tiradas adicionales para consultar el oráculo
            </p>
            <p *ngIf="selectedPrize.id === '2'">
              🔮 Una consulta gratuita de interpretación de sueños te espera
            </p>
            <p *ngIf="selectedPrize.id === '3'">
              🎯 2 tiradas extra han sido agregadas a tu cuenta mística
            </p>
            <p *ngIf="selectedPrize.id === '4'">
              🔄 Las energías te conceden otra oportunidad inmediata
            </p>
          </div>

          <button class="accept-destiny-btn" (click)="onWheelClosedHandler()">
            Aceptar Destino
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
