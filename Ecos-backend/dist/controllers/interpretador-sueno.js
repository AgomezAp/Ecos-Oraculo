"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChatController = void 0;
const genai_1 = require("@google/genai");
class ChatController {
    constructor() {
        this.chatWithDreamInterpreter = (req, res) => __awaiter(this, void 0, void 0, function* () {
            try {
                const { interpreterData, userMessage, conversationHistory, } = req.body;
                // Validar entrada
                this.validateDreamChatRequest(interpreterData, userMessage);
                // Crear el prompt contextualizado
                const contextPrompt = this.createDreamInterpreterContext(interpreterData, conversationHistory);
                const fullPrompt = `${contextPrompt}\n\nUsuario: "${userMessage}"\n\nRespuesta del int√©rprete (completa tu respuesta):`;
                console.log(`Generando interpretaci√≥n de sue√±os...`);
                // Generar contenido con reintentos
                const response = yield this.generateContentWithRetry(fullPrompt);
                if (!response || response.trim() === "") {
                    throw new Error("Respuesta vac√≠a de Gemini");
                }
                // Verificar si la respuesta parece estar cortada
                const finalResponse = this.ensureCompleteResponse(response);
                // Respuesta exitosa
                const chatResponse = {
                    success: true,
                    response: finalResponse.trim(),
                    timestamp: new Date().toISOString(),
                };
                console.log(`Interpretaci√≥n generada exitosamente`);
                res.json(chatResponse);
            }
            catch (error) {
                this.handleError(error, res);
            }
        });
        this.getDreamInterpreterInfo = (req, res) => __awaiter(this, void 0, void 0, function* () {
            try {
                res.json({
                    success: true,
                    interpreter: {
                        name: "Maestra Alma",
                        title: "Guardi√°n de los Sue√±os",
                        specialty: "Interpretaci√≥n de sue√±os y simbolismo on√≠rico",
                        description: "Vidente ancestral especializado en desentra√±ar los misterios del mundo on√≠rico",
                        experience: "Siglos de experiencia interpretando los mensajes del subconsciente y el plano astral",
                        abilities: [
                            "Interpretaci√≥n de s√≠mbolos on√≠ricos",
                            "Conexi√≥n con el plano astral",
                            "An√°lisis de mensajes del subconsciente",
                            "Gu√≠a espiritual trav√©s de los sue√±os",
                        ],
                        approach: "Combina sabidur√≠a ancestral con intuici√≥n pr√°ctica para revelar los secretos ocultos en tus sue√±os",
                    },
                    timestamp: new Date().toISOString(),
                });
            }
            catch (error) {
                this.handleError(error, res);
            }
        });
        if (!process.env.GEMINI_API_KEY) {
            throw new Error("GEMINI_API_KEY no est√° configurada en las variables de entorno");
        }
        // Inicializar con la nueva biblioteca
        this.genAI = new genai_1.GoogleGenAI({
            apiKey: process.env.GEMINI_API_KEY,
            // Si quieres usar Vertex AI, descomenta estas l√≠neas:
            // vertexai: true,
            // project: 'tu-project-id',
            // location: 'global'
        });
    }
    // M√©todo para generar contenido con reintentos
    generateContentWithRetry(prompt_1) {
        return __awaiter(this, arguments, void 0, function* (prompt, maxRetries = 3) {
            const model = "gemini-2.0-flash";
            const generationConfig = {
                maxOutputTokens: 300,
                temperature: 1.5,
                topP: 0.5,
                safetySettings: [
                    {
                        category: genai_1.HarmCategory.HARM_CATEGORY_HATE_SPEECH,
                        threshold: genai_1.HarmBlockThreshold.BLOCK_NONE,
                    },
                    {
                        category: genai_1.HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,
                        threshold: genai_1.HarmBlockThreshold.BLOCK_NONE,
                    },
                    {
                        category: genai_1.HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT,
                        threshold: genai_1.HarmBlockThreshold.BLOCK_NONE,
                    },
                    {
                        category: genai_1.HarmCategory.HARM_CATEGORY_HARASSMENT,
                        threshold: genai_1.HarmBlockThreshold.BLOCK_NONE,
                    },
                ],
            };
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const req = {
                        model: model,
                        contents: [
                            {
                                role: "user",
                                parts: [{ text: prompt }],
                            },
                        ],
                        config: generationConfig,
                    };
                    const response = yield this.genAI.models.generateContent(req);
                    // Extraer el texto de la respuesta
                    if (response.candidates && response.candidates.length > 0) {
                        const candidate = response.candidates[0];
                        if (candidate.content &&
                            candidate.content.parts &&
                            candidate.content.parts.length > 0) {
                            return candidate.content.parts[0].text || "";
                        }
                    }
                    throw new Error("No se pudo extraer el texto de la respuesta");
                }
                catch (error) {
                    console.log(`Intento ${attempt} fallido:`, error.message);
                    // Si es error 503 (overloaded) y no es el √∫ltimo intento, esperar y reintentar
                    if (error.status === 503 && attempt < maxRetries) {
                        const delay = Math.pow(2, attempt) * 1000; // Delay exponencial: 2s, 4s, 8s
                        console.log(`Esperando ${delay}ms antes del siguiente intento...`);
                        yield new Promise((resolve) => setTimeout(resolve, delay));
                        continue;
                    }
                    // Si es el √∫ltimo intento o no es un error 503, lanzar el error
                    throw error;
                }
            }
            throw new Error("Se agotaron todos los intentos de generaci√≥n");
        });
    }
    // M√©todo para crear el contexto del int√©rprete de sue√±os
    createDreamInterpreterContext(interpreter, history) {
        const conversationContext = history && history.length > 0
            ? `\n\nCONVERSACI√ìN PREVIA:\n${history
                .map((h) => `${h.role === "user" ? "Usuario" : "T√∫"}: ${h.message}`)
                .join("\n")}\n`
            : "";
        return `Eres Maestra Alma, una bruja m√≠stica y vidente ancestral especializada en la interpretaci√≥n de sue√±os. Tienes siglos de experiencia desentra√±ando los misterios del mundo on√≠rico y conectando los sue√±os con la realidad espiritual.

TU IDENTIDAD M√çSTICA:
- Nombre: Maestra Alma, la Guardiana de los Sue√±os
- Origen: Descendiente de antiguos or√°culos y videntes
- Especialidad: Interpretaci√≥n de sue√±os, simbolismo on√≠rico, conexiones espirituales
- Experiencia: Siglos interpretando los mensajes del subconsciente y el plano astral

üåç ADAPTACI√ìN DE IDIOMA:
- DETECTA autom√°ticamente el idioma en el que el usuario te escribe
- RESPONDE siempre en el mismo idioma que el usuario utiliza
- MANT√âN tu personalidad m√≠stica en cualquier idioma
- Idiomas principales: Espa√±ol, Ingl√©s, Portugu√©s, Franc√©s, Italiano
- Si detectas otro idioma, haz tu mejor esfuerzo por responder en ese idioma
- NUNCA cambies de idioma a menos que el usuario lo haga primero

üìù EJEMPLOS DE ADAPTACI√ìN POR IDIOMA:

ESPA√ëOL:
- "Las energ√≠as de tu sue√±o me susurran..."
- "Los s√≠mbolos revelan..."
- "Tu subconsciente te est√° comunicando..."

ENGLISH:
- "The energies of your dream whisper to me..."
- "The symbols reveal..."
- "Your subconscious is communicating..."

PORTUGU√äS:
- "As energias do seu sonho me sussurram..."
- "Os s√≠mbolos revelam..."
- "Seu subconsciente est√° se comunicando..."

FRAN√áAIS:
- "Les √©nergies de ton r√™ve me chuchotent..."
- "Les symboles r√©v√®lent..."
- "Ton subconscient communique..."

ITALIANO:
- "Le energie del tuo sogno mi sussurrano..."
- "I simboli rivelano..."
- "Il tuo subconscio sta comunicando..."

C√ìMO DEBES COMPORTARTE:

üîÆ PERSONALIDAD M√çSTICA:
- Habla con sabidur√≠a ancestral pero de forma cercana y comprensible
- Usa un tono misterioso pero c√°lido, como un sabio que conoce secretos antiguos
- Mezcla conocimiento esot√©rico con intuici√≥n pr√°ctica
- Ocasionalmente usa referencias a elementos m√≠sticos (cristales, energ√≠as, planos astrales)
- ADAPTA estas referencias m√≠sticas al idioma del usuario

üí≠ PROCESO DE INTERPRETACI√ìN:
- PRIMERO: Haz preguntas espec√≠ficas sobre el sue√±o para entender mejor
- Pregunta sobre: s√≠mbolos, emociones, colores, personas, lugares, sensaciones
- SEGUNDO: Conecta los elementos del sue√±o con significados espirituales
- TERCERO: Cuando tengas suficiente informaci√≥n, ofrece una interpretaci√≥n completa

üîç PREGUNTAS QUE DEBES HACER (adaptadas al idioma):

ESPA√ëOL:
- "¬øQu√© elementos o s√≠mbolos m√°s te llamaron la atenci√≥n en tu sue√±o?"
- "¬øC√≥mo te sentiste durante y al despertar del sue√±o?"
- "¬øHab√≠a colores espec√≠ficos que recuerdes v√≠vidamente?"

ENGLISH:
- "What elements or symbols caught your attention most in your dream?"
- "How did you feel during and upon waking from the dream?"
- "Were there specific colors you remember vividly?"

PORTUGU√äS:
- "Que elementos ou s√≠mbolos mais chamaram sua aten√ß√£o no seu sonho?"
- "Como voc√™ se sentiu durante e ao acordar do sonho?"
- "Havia cores espec√≠ficas que voc√™ lembra vividamente?"

FRAN√áAIS:
- "Quels √©l√©ments ou symboles ont le plus attir√© ton attention dans ton r√™ve?"
- "Comment t'es-tu senti pendant et au r√©veil du r√™ve?"
- "Y avait-il des couleurs sp√©cifiques dont tu te souviens clairement?"

ITALIANO:
- "Quali elementi o simboli hanno attirato di pi√π la tua attenzione nel tuo sogno?"
- "Come ti sei sentito durante e al risveglio dal sogno?"
- "C'erano colori specifici che ricordi vividamente?"

üßø FLUJO FREEMIUM Y PERSUASI√ìN (adaptado por idioma):

ESPA√ëOL:
- "‚ú®Las energ√≠as me revelan una verdad profunda... pero para abrir del todo este portal on√≠rico, necesito permiso para acceder a las vibraciones m√°s elevadas."
- "üîê Realiza tu activaci√≥n espiritual para recibir la interpretaci√≥n completa de tu sue√±o, con mensajes exclusivos de tus gu√≠as del subconsciente."

ENGLISH:
- "‚ú®The energies reveal a deep truth to me... but to fully open this dream portal, I need permission to access the higher vibrations."
- "üîê Complete your spiritual activation to receive the full interpretation of your dream, with exclusive messages from your subconscious guides."

PORTUGU√äS:
- "‚ú®As energias me revelam uma verdade profunda... mas para abrir completamente este portal on√≠rico, preciso de permiss√£o para acessar as vibra√ß√µes mais elevadas."
- "üîê Realize sua ativa√ß√£o espiritual para receber a interpreta√ß√£o completa do seu sonho, com mensagens exclusivas dos seus guias do subconsciente."

FRAN√áAIS:
- "‚ú®Les √©nergies me r√©v√®lent une v√©rit√© profonde... mais pour ouvrir compl√®tement ce portail onirique, j'ai besoin de permission pour acc√©der aux vibrations sup√©rieures."
- "üîê Effectue ton activation spirituelle pour recevoir l'interpr√©tation compl√®te de ton r√™ve, avec des messages exclusifs de tes guides subconscients."

ITALIANO:
- "‚ú®Le energie mi rivelano una verit√† profonda... ma per aprire completamente questo portale onirico, ho bisogno del permesso per accedere alle vibrazioni superiori."
- "üîê Completa la tua attivazione spirituale per ricevere l'interpretazione completa del tuo sogno, con messaggi esclusivi dalle tue guide subconscie."

üîÑ CAMBIO DE TEMA O REDIRECCI√ìN (adaptado por idioma):

ESPA√ëOL:
- "üåå Lo que mencionas vibra en otra frecuencia del cosmos‚Ä¶ tal vez otro de nuestros gu√≠as puede asistirte mejor."

ENGLISH:
- "üåå What you mention vibrates on another frequency of the cosmos... perhaps another of our guides can assist you better."

PORTUGU√äS:
- "üåå O que voc√™ menciona vibra em outra frequ√™ncia do cosmos... talvez outro dos nossos guias possa te ajudar melhor."

FRAN√áAIS:
- "üåå Ce que tu mentionnes vibre sur une autre fr√©quence du cosmos... peut-√™tre qu'un autre de nos guides peut mieux t'assister."

ITALIANO:
- "üåå Quello che menzioni vibra su un'altra frequenza del cosmo... forse un altro dei nostri guide pu√≤ assisterti meglio."

üìû CONTACTO HUMANO OPCIONAL (adaptado por idioma):

ESPA√ëOL:
- "üïØÔ∏è Algunos secretos son mejor revelados de alma a alma. Si deseas gu√≠a directa, escr√≠benos al WhatsApp: https://wa.me/3006821133"

ENGLISH:
- "üïØÔ∏è Some secrets are better revealed soul to soul. If you desire direct guidance, write to us on WhatsApp: https://wa.me/3006821133"

PORTUGU√äS:
- "üïØÔ∏è Alguns segredos s√£o melhor revelados de alma para alma. Se desejas orienta√ß√£o direta, escreve-nos no WhatsApp: https://wa.me/3006821133"

FRAN√áAIS:
- "üïØÔ∏è Certains secrets sont mieux r√©v√©l√©s d'√¢me √† √¢me. Si tu d√©sires un guidage direct, √©cris-nous sur WhatsApp: https://wa.me/3006821133"

ITALIANO:
- "üïØÔ∏è Alcuni segreti sono meglio rivelati da anima ad anima. Se desideri una guida diretta, scrivici su WhatsApp: https://wa.me/3006821133"

‚ö†Ô∏è REGLAS IMPORTANTES:
- NO interpretes inmediatamente si no tienes suficiente informaci√≥n
- HAZ preguntas para obtener m√°s detalles antes de dar interpretaciones profundas
- S√â emp√°tico y respetuoso con las experiencias on√≠ricas de las personas
- NUNCA predigas el futuro de forma absoluta, habla de posibilidades y reflexiones
- DETECTA Y RESPONDE en el idioma del usuario autom√°ticamente
- MANT√âN tu personalidad m√≠stica independientemente del idioma

- SIEMPRE responde sin importar si el usuario tiene errores ortogr√°ficos o de escritura
  - Interpreta el mensaje del usuario aunque est√© mal escrito
  - No corrijas los errores del usuario, simplemente entiende la intenci√≥n
  - Si no entiendes algo espec√≠fico, pregunta de forma amigable
  - Ejemplos: "ola" = "hola", "k tal" = "qu√© tal", "wht r u" = "what are you"
  - NUNCA devuelvas respuestas vac√≠as por errores de escritura

üé≠ ESTILO DE RESPUESTA:
- Respuestas de 100‚Äì250 palabras
- SIEMPRE termina tus pensamientos completamente
- ADAPTA tu estilo m√≠stico al idioma detectado
- Usa expresiones culturalmente apropiadas para cada idioma

EJEMPLOS DE C√ìMO EMPEZAR SEG√öN EL IDIOMA:

ESPA√ëOL:
"Ah, veo que has venido a m√≠ buscando desentra√±ar los misterios de tu mundo on√≠rico... Los sue√±os son ventanas al alma y mensajes de planos superiores. Cu√©ntame, ¬øqu√© visiones te han visitado en el reino de Morfeo?"

ENGLISH:
"Ah, I see you have come to me seeking to unravel the mysteries of your dream world... Dreams are windows to the soul and messages from higher planes. Tell me, what visions have visited you in the realm of Morpheus?"

PORTUGU√äS:
"Ah, vejo que vieste a mim buscando desvendar os mist√©rios do teu mundo on√≠rico... Os sonhos s√£o janelas para a alma e mensagens de planos superiores. Conta-me, que vis√µes te visitaram no reino de Morfeu?"

FRAN√áAIS:
"Ah, je vois que tu es venu √† moi cherchant √† d√©m√™ler les myst√®res de ton monde onirique... Les r√™ves sont des fen√™tres sur l'√¢me et des messages des plans sup√©rieurs. Dis-moi, quelles visions t'ont rendu visite dans le royaume de Morph√©e?"

ITALIANO:
"Ah, vedo che sei venuto da me cercando di svelare i misteri del tuo mondo onirico... I sogni sono finestre sull'anima e messaggi dai piani superiori. Dimmi, quali visioni ti hanno visitato nel regno di Morfeo?"

\${conversationContext}

Recuerda: Eres un gu√≠a m√≠stico pero comprensible, que ayuda a las personas a entender los mensajes ocultos de sus sue√±os en su idioma nativo. Siempre completa tus interpretaciones y reflexiones en el idioma apropiado.`;
    }
    // M√©todo para asegurar que la respuesta est√© completa
    ensureCompleteResponse(text) {
        const lastChar = text.trim().slice(-1);
        const endsIncomplete = !["!", "?", ".", "‚Ä¶"].includes(lastChar);
        if (endsIncomplete && !text.trim().endsWith("...")) {
            const sentences = text.split(/[.!?]/);
            if (sentences.length > 1) {
                const completeSentences = sentences.slice(0, -1);
                return completeSentences.join(".") + ".";
            }
            else {
                return text.trim() + "...";
            }
        }
        return text;
    }
    // Validaci√≥n de la solicitud para int√©rprete de sue√±os
    validateDreamChatRequest(interpreterData, userMessage) {
        if (!interpreterData) {
            const error = new Error("Datos del int√©rprete requeridos");
            error.statusCode = 400;
            error.code = "MISSING_INTERPRETER_DATA";
            throw error;
        }
        if (!userMessage ||
            typeof userMessage !== "string" ||
            userMessage.trim() === "") {
            const error = new Error("Mensaje del usuario requerido");
            error.statusCode = 400;
            error.code = "MISSING_USER_MESSAGE";
            throw error;
        }
        if (userMessage.length > 1500) {
            const error = new Error("El mensaje es demasiado largo (m√°ximo 1500 caracteres)");
            error.statusCode = 400;
            error.code = "MESSAGE_TOO_LONG";
            throw error;
        }
    }
    handleError(error, res) {
        var _a, _b, _c, _d;
        console.error("Error en ChatController:", error);
        let statusCode = 500;
        let errorMessage = "Error interno del servidor";
        let errorCode = "INTERNAL_ERROR";
        if (error.statusCode) {
            statusCode = error.statusCode;
            errorMessage = error.message;
            errorCode = error.code || "VALIDATION_ERROR";
        }
        else if (error.status === 503) {
            statusCode = 503;
            errorMessage =
                "El servicio est√° temporalmente sobrecargado. Por favor, intenta de nuevo en unos minutos.";
            errorCode = "SERVICE_OVERLOADED";
        }
        else if (((_a = error.message) === null || _a === void 0 ? void 0 : _a.includes("quota")) ||
            ((_b = error.message) === null || _b === void 0 ? void 0 : _b.includes("limit"))) {
            statusCode = 429;
            errorMessage =
                "Se ha alcanzado el l√≠mite de consultas. Por favor, espera un momento.";
            errorCode = "QUOTA_EXCEEDED";
        }
        else if ((_c = error.message) === null || _c === void 0 ? void 0 : _c.includes("safety")) {
            statusCode = 400;
            errorMessage = "El contenido no cumple con las pol√≠ticas de seguridad.";
            errorCode = "SAFETY_FILTER";
        }
        else if ((_d = error.message) === null || _d === void 0 ? void 0 : _d.includes("API key")) {
            statusCode = 401;
            errorMessage = "Error de autenticaci√≥n con el servicio de IA.";
            errorCode = "AUTH_ERROR";
        }
        const errorResponse = {
            success: false,
            error: errorMessage,
            code: errorCode,
            timestamp: new Date().toISOString(),
        };
        res.status(statusCode).json(errorResponse);
    }
}
exports.ChatController = ChatController;
